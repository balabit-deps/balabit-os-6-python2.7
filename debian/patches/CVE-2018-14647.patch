From 18b20bad75b4ff0486940fba4ec680e96e70f3a2 Mon Sep 17 00:00:00 2001
From: Christian Heimes <christian@python.org>
Date: Tue, 18 Sep 2018 15:13:09 +0200
Subject: [PATCH] [2.7] bpo-34623: Use XML_SetHashSalt in _elementtree
 (GH-9146) (GH-9394)

The C accelerated _elementtree module now initializes hash randomization
salt from _Py_HashSecret instead of libexpat's default CPRNG.

Signed-off-by: Christian Heimes <christian@python.org>

https://bugs.python.org/issue34623.
(cherry picked from commit cb5778f00ce48631c7140f33ba242496aaf7102b)

Co-authored-by: Christian Heimes <christian@python.org>



https://bugs.python.org/issue34623
---
 Include/pyexpat.h                                            | 4 +++-
 .../next/Security/2018-09-10-16-05-39.bpo-34623.Ua9jMv.rst   | 2 ++
 Modules/_elementtree.c                                       | 5 +++++
 Modules/pyexpat.c                                            | 5 +++++
 4 files changed, 15 insertions(+), 1 deletion(-)
 create mode 100644 Misc/NEWS.d/next/Security/2018-09-10-16-05-39.bpo-34623.Ua9jMv.rst

Index: python2.7-2.7.12/Include/pyexpat.h
===================================================================
--- python2.7-2.7.12.orig/Include/pyexpat.h	2018-11-12 09:36:09.860993625 -0500
+++ python2.7-2.7.12/Include/pyexpat.h	2018-11-12 09:36:09.856993606 -0500
@@ -3,7 +3,7 @@
 
 /* note: you must import expat.h before importing this module! */
 
-#define PyExpat_CAPI_MAGIC  "pyexpat.expat_CAPI 1.0"
+#define PyExpat_CAPI_MAGIC  "pyexpat.expat_CAPI 1.1"
 #define PyExpat_CAPSULE_NAME "pyexpat.expat_CAPI"
 
 struct PyExpat_CAPI 
@@ -43,6 +43,8 @@ struct PyExpat_CAPI
         XML_Parser parser, XML_UnknownEncodingHandler handler,
         void *encodingHandlerData);
     void (*SetUserData)(XML_Parser parser, void *userData);
+    /* might be none for expat < 2.1.0 */
+    int (*SetHashSalt)(XML_Parser parser, unsigned long hash_salt);
     /* always add new stuff to the end! */
 };
 
Index: python2.7-2.7.12/Modules/_elementtree.c
===================================================================
--- python2.7-2.7.12.orig/Modules/_elementtree.c	2018-11-12 09:36:09.860993625 -0500
+++ python2.7-2.7.12/Modules/_elementtree.c	2018-11-12 09:36:09.856993606 -0500
@@ -2613,6 +2613,11 @@ expat_parse(XMLParserObject* self, char*
             );
         return NULL;
     }
+    /* expat < 2.1.0 has no XML_SetHashSalt() */
+    if (EXPAT(SetHashSalt) != NULL) {
+        EXPAT(SetHashSalt)(self->parser,
+                           (unsigned long)_Py_HashSecret.prefix);
+    }
 
     Py_RETURN_NONE;
 }
Index: python2.7-2.7.12/Modules/pyexpat.c
===================================================================
--- python2.7-2.7.12.orig/Modules/pyexpat.c	2018-11-12 09:36:09.860993625 -0500
+++ python2.7-2.7.12/Modules/pyexpat.c	2018-11-12 09:36:09.856993606 -0500
@@ -2044,6 +2044,11 @@ MODULE_INITFUNC(void)
     capi.SetProcessingInstructionHandler = XML_SetProcessingInstructionHandler;
     capi.SetUnknownEncodingHandler = XML_SetUnknownEncodingHandler;
     capi.SetUserData = XML_SetUserData;
+#if XML_COMBINED_VERSION >= 20100
+    capi.SetHashSalt = XML_SetHashSalt;
+#else
+    capi.SetHashSalt = NULL;
+#endif
 
     /* export using capsule */
     capi_object = PyCapsule_New(&capi, PyExpat_CAPSULE_NAME, NULL);
